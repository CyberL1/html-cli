<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <title>html-cli playground</title>
  <script src="wasm_exec.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.52.2/min/vs/loader.js"></script>
</head>

<style>
  .flex {
    display: flex;
  }

  .flex>.files {
    border: 1px solid red;
    width: 200px;
    user-select: none;
  }

  .flex>.files>div.selected {
    background-color: grey;
    cursor: pointer;
  }

  .flex>.files>div:hover {
    background-color: grey;
    cursor: pointer;
  }

  .flex>.editor {
    flex: 1;
    height: 600px;
    border: 1px solid grey;
  }

  .output {
    border: 1px solid #ccc;
    padding: 10px;
  }
</style>

<div class="flex">
  <div class="files"></div>
  <div class="editor"></div>
</div>

<pre class="output"></pre>

<script>
  const fileTree = document.querySelector("div.files");
  const output = document.querySelector("pre.output");

  window.onload = async () => {
    output.textContent = "";

    const go = new Go();
    const result = await WebAssembly.instantiateStreaming(fetch("html-cli.wasm"), go.importObject);

    go.run(result.instance);

    // Setup editor
    require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.52.2/min/vs" } });

    require(["vs/editor/editor.main"], function (monaco) {
      // Setup starter files
      writeFile("html-cli.json", JSON.stringify({
        "build": {
          "directory": "build",
          "html": {
            "keepDocumentTags": false,
            "keepComments": false,
            "keepConditionalComments": false,
            "keepSpecialComments": false,
            "keepDefaultAttrVals": false,
            "keepEndTags": false,
            "keepQuotes": false,
            "keepWhitespace": false,
            "templateDelims": ["{", "}"]
          },
          "css": {
            "precision": 0,
            "keepCSS2": false
          },
          "js": {
            "keepVarNames": false,
            "precision": 0,
            "version": 0
          }
        }
      }, null, 2));

      writeFile("index.html", "index.html");
      writeFile("index.js", "'index.js';");

      const prefersDarkTheme = window.matchMedia("(prefers-color-scheme: dark)");
      let currentFile = "index.html";

      build(".");
      updateFileTree();

      const editor = monaco.editor.createDiffEditor(document.querySelector("div.editor"), {
        theme: prefersDarkTheme.matches ? "vs-dark" : "vs-light",
        automaticLayout: true,
        originalEditable: true,
        readOnly: true,
        scrollBeyondLastLine: false
      });

      monaco.editor.addKeybindingRules([
        {
          keybinding: monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS,
          command: "editor.action.formatDocument"
        }
      ]);

      prefersDarkTheme.addEventListener("change", () => {
        monaco.editor.setTheme(prefersDarkTheme.matches ? "vs-dark" : "vs-light");
      });

      editor.setModel({
        original: createModel(currentFile),
        modified: createModel(currentFile === "html-cli.json" ? currentFile : "build/" + currentFile)
      })

      editor.getOriginalEditor().onDidChangeModelContent(() => {
        writeFile(currentFile, editor.getOriginalEditor().getValue());
        output.textContent = "";

        build(".");
        updateFileTree();

        const updatedContent = new TextDecoder().decode(readFile(currentFile === "html-cli.json" ? currentFile : "build/" + currentFile));
        editor.getModifiedEditor().setValue(updatedContent);
      });

      fileTree.onclick = event => {
        const { target } = event;

        if (target.classList.contains("files") || target.classList.contains("selected")) {
          return;
        }

        const selectedElements = fileTree.querySelectorAll(".selected");

        selectedElements.forEach(element => element.classList.remove("selected"));
        target.classList.add("selected");

        currentFile = target.textContent;

        editor.setModel({
          original: createModel(currentFile),
          modified: createModel("build/" + currentFile)
        })
      }

      function createModel(file) {
        const oldModel = monaco.editor.getModel(monaco.Uri.file(file));
        if (oldModel) oldModel.dispose();

        return monaco.editor.createModel(
          new TextDecoder().decode(readFile(file)),
          undefined,
          monaco.Uri.file(file)
        );
      }

      function updateFileTree() {
        fileTree.textContent = ""; // Reset the tree

        for (const file of readDir(".")) {
          const div = document.createElement("div");

          div.setAttribute("data-filename", file.name);
          div.textContent = file.name;

          div.classList.add(file.isDir ? "dir" : "file");
          fileTree.appendChild(div);
        }
        fileTree.querySelector(`div.file[data-filename="${currentFile}"]`).classList.add("selected");
      }
    });
  }

  console.log = (...args) => output.textContent += args.join(" ") + "\n";
</script>
